<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Sistema de Estoque</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet" crossorigin="anonymous">

    <style>
        body {
            background-color: #f5f5f5;
        }

        .card-summary h3 {
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            min-height: 320px;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">Sistema de Estoque</a>
        <span class="navbar-text">
            <a href="/logout" class="link-light text-decoration-none">Sair</a>
        </span>
    </div>
</nav>

<div class="container mt-4">

    <h1 class="mb-2">Dashboard</h1>
    <p class="text-muted mb-4">Visão geral do seu estoque.</p>

    <!-- CARDS DE RESUMO -->
    <div class="row g-4 mb-4">

        <div class="col-md-4">
            <div class="card shadow-sm border-0 card-summary">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase mb-1">Produtos cadastrados</h6>
                    <h3 class="mb-0" th:text="${totalProducts}">0</h3>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm border-0 card-summary">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase mb-1">Quantidade total em estoque</h6>
                    <h3 class="mb-0" th:text="${totalQuantity}">0</h3>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm border-0 card-summary">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase mb-1">Valor total em estoque</h6>
                    <h3 class="mb-0"
                        th:text="${'R$ ' + #numbers.formatDecimal(totalValue, 1, 'POINT', 2, 'COMMA')}">R$ 0,00</h3>
                </div>
            </div>
        </div>

    </div>

    <!-- CARDS DE NAVEGAÇÃO -->
    <div class="row g-4 mb-4">

        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title">Produtos</h5>
                    <p class="card-text">Cadastre, edite e visualize os produtos do seu estoque.</p>
                    <a href="/products" class="btn btn-primary">Gerenciar produtos</a>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title">Usuários (admin)</h5>
                    <p class="card-text">Gerencie os usuários que podem acessar o sistema e seus perfis.</p>
                    <a href="/users" class="btn btn-primary">Gerenciar usuários</a>
                </div>
            </div>
        </div>

    </div>

    <!-- GRÁFICOS -->
    <div class="row g-4 mb-4">

        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Quantidade por produto</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-2" th:if="${totalProducts == 0}">
                        Nenhum produto cadastrado para exibir o gráfico.
                    </p>
                    <div class="chart-container" th:if="${totalProducts > 0}">
                        <canvas id="quantityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Valor total por produto</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-2" th:if="${totalProducts == 0}">
                        Nenhum produto cadastrado para exibir o gráfico.
                    </p>
                    <div class="chart-container" th:if="${totalProducts > 0}">
                        <canvas id="valueChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>

</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Script dos gráficos -->
<script th:inline="javascript">
    /*<![CDATA[*/

    const productNames = /*[[${names}]]*/ [];
    const productQuantities = /*[[${quantities}]]*/ [];
    const productValues = /*[[${values}]]*/ [];

    if (productNames.length > 0) {

        // formatter para valores em reais
        const currencyFormatter = new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        });

        // GRÁFICO DE QUANTIDADE
        const ctx1 = document.getElementById('quantityChart');
        if (ctx1) {
            new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: productNames,
                    datasets: [{
                        label: 'Quantidade em estoque',
                        data: productQuantities,
                        backgroundColor: 'rgba(54, 162, 235, 0.4)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return 'Quantidade: ' + context.parsed.y;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        },
                        x: {
                            ticks: {
                                autoSkip: false,
                                maxRotation: 45,
                                minRotation: 20
                            }
                        }
                    }
                }
            });
        }

        // GRÁFICO DE VALOR
        const ctx2 = document.getElementById('valueChart');
        if (ctx2) {
            new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: productNames,
                    datasets: [{
                        label: 'Valor total em estoque (R$)',
                        data: productValues,
                        backgroundColor: 'rgba(75, 192, 192, 0.4)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return currencyFormatter.format(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return currencyFormatter.format(value);
                                }
                            }
                        },
                        x: {
                            ticks: {
                                autoSkip: false,
                                maxRotation: 45,
                                minRotation: 20
                            }
                        }
                    }
                }
            });
        }
    }

    /*]]>*/
</script>

</body>
</html>
