<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Produtos</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet" crossorigin="anonymous">
</head>
<body>
<nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">Sistema de Estoque</a>
        <span class="navbar-text">
            <a href="/logout" class="text-light text-decoration-none">Sair</a>
        </span>
    </div>
</nav>

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Produtos</h2>
        <a href="/products/new" class="btn btn-primary">Novo Produto</a>
    </div>

    <!-- FILTROS: busca + ordenação -->
    <form class="row g-2 mb-3" th:action="@{/products}" method="get">

        <!-- busca por nome -->
        <div class="col-md-4">
            <input type="text"
                   name="search"
                   class="form-control"
                   placeholder="Buscar por nome"
                   th:value="${search}">
        </div>

        <!-- campo de ordenação -->
        <div class="col-md-3">
            <select name="sortField" class="form-select">
                <option th:value="'id'"       th:selected="${sortField} == 'id'">Ordenar por ID</option>
                <option th:value="'name'"     th:selected="${sortField} == 'name'">Ordenar por Nome</option>
                <option th:value="'price'"    th:selected="${sortField} == 'price'">Ordenar por Preço</option>
                <option th:value="'quantity'" th:selected="${sortField} == 'quantity'">Ordenar por Quantidade</option>
            </select>
        </div>

        <!-- direção da ordenação -->
        <div class="col-md-3">
            <select name="sortDir" class="form-select">
                <option th:value="'asc'"  th:selected="${sortDir} == 'asc'">Ascendente</option>
                <option th:value="'desc'" th:selected="${sortDir} == 'desc'">Descendente</option>
            </select>
        </div>

        <div class="col-md-2">
            <button class="btn btn-secondary w-100" type="submit">Aplicar filtros</button>
        </div>
    </form>

    <!-- MENSAGENS -->
    <div th:if="${message}"
         class="alert"
         th:classappend="${messageType} != null ? ' alert-' + ${messageType} : ' alert-info'">
        <span th:text="${message}"></span>
    </div>

    <!-- TABELA DE PRODUTOS -->
    <table class="table table-striped">
        <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Nome</th>
            <th>Quantidade</th>
            <th>Preço</th>
            <th>Ações</th>
        </tr>
        </thead>

        <tbody>
        <tr th:each="p : ${products}">
            <td th:text="${p.id}"></td>
            <td th:text="${p.name}"></td>
            <td th:text="${p.quantity}"></td>

            <!-- preço formatado: R$ 9.550,00 -->
            <td th:text="${'R$ ' + #numbers.formatDecimal(p.price, 1, 'POINT', 2, 'COMMA')}"></td>

            <td>
                <!-- botões com cores menos chamativas -->
                <a th:href="@{'/products/edit/' + ${p.id}}"
                   class="btn btn-sm btn-outline-primary me-1">
                    Editar
                </a>

                <!-- abre modal de confirmação -->
                <button type="button"
                        class="btn btn-sm btn-outline-danger"
                        th:onclick="|openDeleteModal(${p.id})|">
                    Excluir
                </button>
            </td>
        </tr>
        </tbody>
    </table>

    <!-- PAGINAÇÃO CENTRALIZADA -->
    <nav th:if="${totalPages > 1}" class="d-flex justify-content-center">
        <ul class="pagination justify-content-center">

            <!-- Anterior -->
            <li class="page-item" th:classappend="${currentPage == 1} ? ' disabled'">
                <a class="page-link"
                   th:href="@{/products(page=${currentPage - 1}, search=${search},
                                       sortField=${sortField}, sortDir=${sortDir})}">
                    Anterior
                </a>
            </li>

            <!-- Número das páginas -->
            <li class="page-item"
                th:each="i : ${#numbers.sequence(1, totalPages)}"
                th:classappend="${i == currentPage} ? ' active'">
                <a class="page-link"
                   th:text="${i}"
                   th:href="@{/products(page=${i}, search=${search},
                                       sortField=${sortField}, sortDir=${sortDir})}">
                </a>
            </li>

            <!-- Próxima -->
            <li class="page-item" th:classappend="${currentPage == totalPages} ? ' disabled'">
                <a class="page-link"
                   th:href="@{/products(page=${currentPage + 1}, search=${search},
                                       sortField=${sortField}, sortDir=${sortDir})}">
                    Próxima
                </a>
            </li>

        </ul>
    </nav>

    <!-- VOLTAR PARA HOME -->
    <a href="/" class="mt-3 d-inline-block">Voltar para Home</a>

</div>

<!-- MODAL DE CONFIRMAÇÃO DE EXCLUSÃO -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirmar exclusão</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                Tem certeza de que deseja excluir este produto?<br>
                <strong>Essa ação não pode ser desfeita.</strong>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <a id="confirmDeleteBtn" href="#" class="btn btn-danger">Excluir</a>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>

<!-- Script do modal de exclusão -->
<script th:inline="javascript">
    function openDeleteModal(id) {
        // URL base segura com contexto da aplicação
        const baseUrl = /*[[@{/products/delete/}]]*/ '/products/delete/';
        const deleteUrl = baseUrl + id;

        document.getElementById('confirmDeleteBtn').setAttribute('href', deleteUrl);

        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
    }
</script>

</body>
</html>
